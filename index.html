<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>DMP3 AR Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- A-Frame + MindAR (make sure the script tags are correct) -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <!-- Gesture controls for Poster 2 (pinch to scale, two-finger rotate) -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-gesture-component@4.0.5/dist/aframe-gesture-component.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }

    /* Blue circular button with white SVG icon (shared by P1/P2) */
    .btn {
      position: fixed;
      bottom: 20px;
      left: 20px;               /* Consistent bottom-left placement */
      width: 70px;
      height: 70px;
      background: #1e5df8;      /* your blue */
      border-radius: 50%;
      z-index: 1000;
      user-select: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(30, 93, 248, 0.35);
      transition: transform 0.1s ease;
      touch-action: manipulation;
    }
    .btn:active { transform: scale(0.96); }
    .btn svg { width: 34px; height: 34px; fill: white; display: block; }

    /* Tell me more pill (Poster 2) — sentence case */
    #tellMeMoreBtn_p2 {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      background: #1e5df8;      /* your blue */
      color: #fff;
      border-radius: 30px;
      padding: 14px 22px;
      font-size: 16px;
      font-weight: 600;
      z-index: 1000;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 8px 24px rgba(30, 93, 248, 0.35);
      touch-action: manipulation;
      white-space: nowrap;
    }

    .hidden { display: none !important; }

    /* Close button (keep your black transparent style) */
    #closeBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 55px;
      height: 55px;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 26px;
      text-align: center;
      line-height: 55px;
      border-radius: 50%;
      z-index: 1000;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
    }

    /* Audio unlock overlay */
    #audioOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      text-align: center;
      z-index: 2000;
      cursor: pointer;
      padding: 24px;
    }

    @media (max-width: 420px) {
      .btn { width: 62px; height: 62px; }
      .btn svg { width: 28px; height: 28px; }
      #closeBtn { width: 48px; height: 48px; font-size: 22px; line-height: 48px; }
      #audioOverlay { font-size: 18px; }
      #tellMeMoreBtn_p2 { padding: 12px 18px; font-size: 15px; }
    }
  </style>
</head>

<body>

  <!-- =================== AR Scene =================== -->
  <a-scene
    mindar-image="imageTargetSrc: ./assets/targets.mind; filterMinCF: 0.0001; filterBeta: 0.001;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
    gesture-detector
  >
    <a-assets>
      <!-- Poster 1 video -->
      <video id="videoAsset"
             src="./assets/video.mp4"
             preload="auto"
             loop
             crossorigin="anonymous"
             playsinline>
      </video>

      <!-- Poster 2 model -->
      <a-asset-item id="modelAsset" src="./assets/quantum-model-shaded.glb" crossorigin="anonymous"></a-asset-item>

      <!-- Poster 2 voiceover -->
      <audio id="voiceAsset"
             src="./assets/quantum-voiceover.mp3"
             preload="auto"
             crossorigin="anonymous">
      </audio>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <!-- Poster 1 target (index 0) -->
    <a-entity mindar-image-target="targetIndex: 0" id="targetP1">
      <a-video id="arVideo"
               src="#videoAsset"
               width="1.6"
               height="0.9"
               position="0 0 0"
               visible="false">
      </a-video>
    </a-entity>

    <!-- Poster 2 target (index 1) -->
    <a-entity mindar-image-target="targetIndex: 1" id="targetP2">
      <a-entity id="modelEntity"
        gltf-model="#modelAsset"
        scale="0.5 0.5 0.5"
        rotation="0 0 0"
        position="0 0 0"
        visible="false"
        gesture-controls="minScale: 0.2; maxScale: 3; rotateEnabled: true; scaleEnabled: true; dragEnabled: false;">
      </a-entity>
    </a-entity>
  </a-scene>

  <!-- =================== Overlay UI =================== -->

  <!-- Poster 1: Play/Pause video (blue circle) -->
  <div id="togglePlayPauseBtn_p1" class="btn hidden" role="button" aria-label="Play video" aria-pressed="false">
    <!-- PLAY icon -->
    <svg id="iconPlay_p1" viewBox="0 0 100 100">
      <polygon points="30,20 80,50 30,80"></polygon>
    </svg>
    <!-- PAUSE icon -->
    <svg id="iconPause_p1" viewBox="0 0 100 100" style="display:none;">
      <rect x="25" y="20" width="18" height="60"></rect>
      <rect x="57" y="20" width="18" height="60"></rect>
    </svg>
  </div>

  <!-- Poster 2: Tell me more (blue pill, center bottom) -->
  <div id="tellMeMoreBtn_p2" class="hidden" role="button" aria-label="Tell me more">
    Tell me more
  </div>

  <!-- Poster 2: Play/Pause voiceover (blue circle) -->
  <div id="togglePlayPauseBtn_p2" class="btn hidden" role="button" aria-label="Play audio" aria-pressed="false">
    <!-- PLAY icon -->
    <svg id="iconPlay_p2" viewBox="0 0 100 100">
      <polygon points="30,20 80,50 30,80"></polygon>
    </svg>
    <!-- PAUSE icon -->
    <svg id="iconPause_p2" viewBox="0 0 100 100" style="display:none;">
      <rect x="25" y="20" width="18" height="60"></rect>
      <rect x="57" y="20" width="18" height="60"></rect>
    </svg>
  </div>

  <!-- Shared close button -->
  <div id="closeBtn" class="hidden" aria-label="Close">✕</div>

  <!-- Audio unlock overlay -->
  <div id="audioOverlay">Tap to Enable Sound</div>

  <script>
    window.onload = () => {
      // ===== Elements
      const video = document.querySelector('#videoAsset');
      const videoEntity = document.querySelector('#arVideo');

      const voice = document.querySelector('#voiceAsset');
      const modelEntity = document.querySelector('#modelEntity');

      const targetP1 = document.querySelector('#targetP1');
      const targetP2 = document.querySelector('#targetP2');

      const btnP1 = document.getElementById('togglePlayPauseBtn_p1');
      const iconPlayP1 = document.getElementById('iconPlay_p1');
      const iconPauseP1 = document.getElementById('iconPause_p1');

      const tellBtnP2 = document.getElementById('tellMeMoreBtn_p2');
      const btnP2 = document.getElementById('togglePlayPauseBtn_p2');
      const iconPlayP2 = document.getElementById('iconPlay_p2');
      const iconPauseP2 = document.getElementById('iconPause_p2');

      const closeBtn = document.getElementById('closeBtn');
      const audioOverlay = document.getElementById('audioOverlay');

      // Which poster is active: 'p1' | 'p2' | null
      let activePoster = null;

      // Scale factor for video plane (from your original)
      const scaleMultiplier = 0.65;
      videoEntity.object3D.scale.set(scaleMultiplier, scaleMultiplier, scaleMultiplier);

      // ===== UI helpers
      const show = el => el.classList.remove('hidden');
      const hide = el => el.classList.add('hidden');

      function updateBtnP1() {
        const paused = video.paused;
        iconPlayP1.style.display = paused ? 'block' : 'none';
        iconPauseP1.style.display = paused ? 'none' : 'block';
        btnP1.setAttribute('aria-label', paused ? 'Play video' : 'Pause video');
        btnP1.setAttribute('aria-pressed', String(!paused));
      }

      function updateBtnP2() {
        const paused = voice.paused;
        iconPlayP2.style.display = paused ? 'block' : 'none';
        iconPauseP2.style.display = paused ? 'none' : 'block';
        btnP2.setAttribute('aria-label', paused ? 'Play audio' : 'Pause audio');
        btnP2.setAttribute('aria-pressed', String(!paused));
      }

      function hideAllControls() {
        hide(btnP1);
        hide(btnP2);
        hide(tellBtnP2);
        hide(closeBtn);
      }

      // ===== Audio unlock overlay (tap once to allow unmuted playback on iOS)
      audioOverlay.addEventListener('click', () => {
        // Unmute and "prime" both media (without actually playing)
        video.muted = false;
        voice.muted = false;

        const primeVideo = video.play().then(() => video.pause()).catch(() => {});
        const primeAudio = voice.play().then(() => voice.pause()).catch(() => {});

        Promise.allSettled([primeVideo, primeAudio]).finally(() => {
          audioOverlay.style.display = 'none';
        });
      });

      // ===================== Poster 1 (Video) =====================
      targetP1.addEventListener('targetFound', () => {
        // Ensure Poster 2 audio is stopped if switching quickly
        voice.pause();
        voice.currentTime = 0;

        activePoster = 'p1';
        videoEntity.object3D.visible = true;
        video.play().catch(() => {}); // in case overlay not tapped yet

        updateBtnP1();
        show(btnP1);
        show(closeBtn);
        hide(btnP2);
        hide(tellBtnP2);
      });

      targetP1.addEventListener('targetLost', () => {
        video.pause();
        updateBtnP1();
        videoEntity.object3D.visible = false;

        if (activePoster === 'p1') {
          hide(btnP1);
          hide(closeBtn);
          activePoster = null;
        }
      });

      btnP1.addEventListener('click', () => {
        if (video.paused) {
          video.play().catch(() => {});
        } else {
          video.pause();
        }
        updateBtnP1();
      });

      // ===================== Poster 2 (Model + Voiceover) =====================
      targetP2.addEventListener('targetFound', () => {
        // Ensure Poster 1 video is stopped if switching quickly
        video.pause();

        activePoster = 'p2';
        modelEntity.setAttribute('visible', true);

        // No auto audio. Show "Tell me more" pill. Hide P2 play/pause until user opts in.
        show(tellBtnP2);
        hide(btnP2);

        show(closeBtn);
        hide(btnP1);
      });

      targetP2.addEventListener('targetLost', () => {
        voice.pause();
        voice.currentTime = 0;
        updateBtnP2();

        modelEntity.setAttribute('visible', false);

        if (activePoster === 'p2') {
          hide(btnP2);
          hide(tellBtnP2);
          hide(closeBtn);
          activePoster = null;
        }
      });

      // Tell me more → start audio, swap to play/pause
      tellBtnP2.addEventListener('click', () => {
        voice.play().then(() => {
          hide(tellBtnP2);
          show(btnP2);
          updateBtnP2();
        }).catch(() => {
          // If blocked for any reason, keep "Tell me more" visible
        });
      });

      // P2 play/pause (voiceover)
      btnP2.addEventListener('click', () => {
        if (voice.paused) {
          voice.play().catch(() => {});
        } else {
          voice.pause();
        }
        updateBtnP2();
      });

      // Close button: stop/hide current poster content
      closeBtn.addEventListener('click', () => {
        if (activePoster === 'p1') {
          video.pause();
          video.currentTime = 0;
          videoEntity.object3D.visible = false;
          updateBtnP1();
          hide(btnP1);
        } else if (activePoster === 'p2') {
          voice.pause();
          voice.currentTime = 0;
          modelEntity.setAttribute('visible', false);
          updateBtnP2();
          hide(btnP2);
          hide(tellBtnP2);
        }
        hide(closeBtn);
        activePoster = null;
      });

      // Initialize states
      updateBtnP1();
      updateBtnP2();
      hideAllControls();
    };
  </script>
</body>
</html>
``
